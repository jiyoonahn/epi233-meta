---
title: "Untitled"
author: "Satoshi"
date: "5/4/2019"
output: html_document
---

```{r}
library(dplyr)
library(meta)
library(foreign)
library(readxl)
library(dosresmeta)
library(ggplot2)
```

```{r}
df<-read.csv("EPI233_meta_analysis.csv")

df<-df%>%dplyr::select("author","year","location","design","setting","icu_type","age_cat","mean_median_age","age_cat_2","N","male","MV_duration","steroid","cum_dose_equi_hydro","mean_time_first_dosing","observation_period","n_control_gibleed","event_control_gibleed","n_steroid_gibleed","event_steroid_gibleed","n_control_hyperglycemia","event_control_hyperglycemia","n_steroid_hyperglycemia","event_steroid_hyperglycemia","n_control_stridor","event_control_stridor","n_steroid_stridor","event_steroid_stridor","n_control_reintubation","event_control_reintubation","n_steroid_reintubation","event_steroid_reintubation")
head(df)

edema <- df %>% # keep only relevant rows
        filter(!is.na(year))%>%arrange(year)
# "edema" is the name of our working dataset!


<<<<<<< HEAD
as_tibble(edema)
summary(edema$setting)
=======

edema <- edema %>% #change column names: upper case to lower case
        rename(n = N, mv_duration = MV_duration) 
>>>>>>> f957acfbb9755ca58979085f1a1f239c41c3aa57
```

#RCT
##Stridor
```{r}
edema_rct_str<-edema%>%filter(design=="RCT", !is.na(n_control_stridor))

#Forest
#Fixed-effect
meta_fix<-metabin(event_steroid_stridor,n_steroid_stridor,event_control_stridor,n_control_stridor,data=edema_rct_str,studlab=paste(author,year),comb.fixed=T,comb.random=F,sm="RR")
forest(meta_fix,lab.e="Steroid")

#Random-effect
meta_ran<-metabin(event_steroid_stridor,n_steroid_stridor,event_control_stridor,n_control_stridor,data=edema_rct_str,studlab=paste(author,year),comb.fixed=F,comb.random=T,sm="RR",method.tau = "EB")
forest(meta_ran,lab.e="Steroid")

#Funnel plot
funnel(meta_fix)


#meta-regression
output_metareg<-metareg(meta_fix,cum_dose_equi_hydro)
bubble(output_metareg,xlim=c(0,80),ylim=c(-2,2),studlab = TRUE,cex.studlab=0.6,pos=3)

output_metareg<-metareg(meta_fix,mean_median_age)
bubble(output_metareg,xlim=c(-1,8),ylim=c(-2,2),studlab = TRUE,cex.studlab=0.6,pos=3)

output_metareg<-metareg(meta_fix,mean_time_first_dosing)
bubble(output_metareg,xlim=c(-1,12),ylim=c(-2,2),studlab = TRUE,cex.studlab=0.6,pos=3)


#Sub-analysis for age_cat
d<-edema_rct_str%>%filter(age_cat_2==0)# for under 1 yo
metabin(event_steroid_stridor,n_steroid_stridor,event_control_stridor,n_control_stridor,data=d,studlab=paste(author),comb.fixed=T,comb.random=F,sm="OR")%>%forest()

d<-edema_rct_str%>%filter(age_cat_2==1)# for older than 1 yo
metabin(event_steroid_stridor,n_steroid_stridor,event_control_stridor,n_control_stridor,data=d,studlab=paste(author),comb.fixed=T,comb.random=F,sm="OR")%>%forest()

```

##Re-intubation
```{r}
edema_rct_reint<-edema%>%filter(design=="RCT", !is.na(n_control_reintubation))

#Forest
#Fixed-effect
meta_fix<-metabin(event_steroid_reintubation,n_steroid_reintubation,event_control_reintubation,n_control_reintubation,data=edema_rct_reint,studlab=paste(author,year),comb.fixed=T,comb.random=F,sm="RR")
forest(meta_fix, lab.e="Steroid")

#Random-effect
meta_ran<-metabin(event_steroid_reintubation,n_steroid_reintubation,event_control_reintubation,n_control_reintubation,data=edema_rct_reint,studlab=paste(author),comb.fixed=F,comb.random=T,sm="RR",method.tau = "EB")
forest(meta_ran,lab.e="Steroid")

#Funnel plot
funnel(meta_fix)


#meta-regression
output_metareg<-metareg(meta_fix,cum_dose_equi_hydro)
bubble(output_metareg,xlim=c(0,80),ylim=c(-3,2),studlab = TRUE,cex.studlab=0.6,pos=3)

output_metareg<-metareg(meta_fix,mean_median_age)
bubble(output_metareg,xlim=c(-1,8),ylim=c(-3,2),studlab = TRUE,cex.studlab=0.6,pos=3)

output_metareg<-metareg(meta_fix,mean_time_first_dosing)
bubble(output_metareg,xlim=c(-1,12),ylim=c(-3,2),studlab = TRUE,cex.studlab=0.6,pos=3)


#Sub-analysis for age_cat
d<-edema_rct_reint%>%filter(age_cat_2==0)# for under 1 yo
metabin(event_steroid_reintubation,n_steroid_reintubation,event_control_reintubation,n_control_reintubation,data=d,studlab=paste(author),comb.fixed=T,comb.random=F,sm="OR")%>%forest()

d<-edema_rct_reint%>%filter(age_cat_2==1)# for older than 1 yo
metabin(event_steroid_reintubation,n_steroid_reintubation,event_control_reintubation,n_control_reintubation,data=d,studlab=paste(author),comb.fixed=T,comb.random=F,sm="OR")%>%forest()
```
